#!/bin/bash

# Copyright 2019 Dallen Wilson
# Distributed under the terms of the GNU General Public License v3

# emmakekernel v1.0.0
# Used to build a new kernel and all associated steps in installing it,
# as well as rebuilding any installed modules.

source /etc/emtools.conf

# Move to kernel source
cd /usr/src/linux

# Make kernel and modules
/usr/bin/make modules_prepare
/usr/bin/make $emtools_kernproc
/usr/bin/make modules_install

# Install kernel to /boot
/usr/bin/make install

# Build initramfs and install to /boot
/usr/bin/genkernel --install initramfs

# Update the grub
/usr/sbin/grub-mkconfig -o /boot/grub/grub.cfg

# Backup /boot to $emtools_bootbak
if [ -z "$emtools_bootbak" ]; then
	/usr/bin/rsync -av /boot/ $emtools_bootbak

fi

# Rebuild other modules
emerge @module-rebuild
#emerge sys-kernel/linux-firmware
